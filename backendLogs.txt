>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 7e399408-010e-4910-9d3e-ade06c9e619e <<<
2026-01-02 10:00:17,377 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 7e399408-010e-4910-9d3e-ade06c9e619e <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56626 - "WebSocket /api/ws/scripts/7e399408-010e-4910-9d3e-ade06c9e619e?token=eyJhbGciOiJSUzI1NiIsImtpZCI6ImEzOGVhNmEwNDA4YjBjYzVkYTE4OWRmYzg4ODgyZDBmMWI3ZmJmMGUiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NzAzMTA5NSwidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY3Mzc0OTI0LCJleHAiOjE3NjczNzg1MjQsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.enJayneMZtPZAIwSQGR-H_VMlAwHq5m2yDalD5EdP-G9I3oSx2CgNseQwX-edQoLJVQASJg1BvUhy7rOkgsCFipmZ0ZPAW0csq4BJlF8O8mJYRpbOBKWers3JJMF2Xnl07w7n7Dw2YJ3G1SoaSYs0kJTsFmsI-eTp18PuV1P4QuC2XiNf-GHo902UFoLXdJ15Vknf-AnRFgjipDE2GUA7vZE7Z-g4OBR4eBhQJZKQWo40tRhqL0Xz7iiALqXVT9aMTSCNjSrhn_jYKY0O7ixcaPeIgesrnx-pkCjLg91H7QL1TOYtRXB-CP-m-rzlZY0C6AAsF8VPxrio7tAqErbfw" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2026-01-02 10:00:17,378 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 3: Starting token verification for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:17,378 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2026-01-02 10:00:17,379 - app.routers.script_websocket - INFO - Token verified successfully for script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
ðŸ”µ Incoming request: OPTIONS /api/ai/chat/script/7e399408-010e-4910-9d3e-ade06c9e619e/conversations
ðŸ”µ Incoming request: OPTIONS /api/scripts/7e399408-010e-4910-9d3e-ade06c9e619e/content
âœ… Completed: OPTIONS /api/ai/chat/script/7e399408-010e-4910-9d3e-ade06c9e619e/conversations - 200 - 0.000s
âœ… Completed: OPTIONS /api/scripts/7e399408-010e-4910-9d3e-ade06c9e619e/content - 200 - 0.000s
INFO:     127.0.0.1:56614 - "OPTIONS /api/ai/chat/script/7e399408-010e-4910-9d3e-ade06c9e619e/conversations HTTP/1.1" 200 OK
INFO:     127.0.0.1:56612 - "OPTIONS /api/scripts/7e399408-010e-4910-9d3e-ade06c9e619e/content HTTP/1.1" 200 OK
ðŸ”µ Incoming request: GET /api/ai/chat/script/7e399408-010e-4910-9d3e-ade06c9e619e/conversations
DEBUG: Authentication process started
DEBUG: Token received: eyJhbGciOiJSUzI...
DEBUG: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG: Looking up user with firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
ðŸ”µ Incoming request: GET /api/scripts/7e399408-010e-4910-9d3e-ade06c9e619e/content
DEBUG: Authentication process started
DEBUG: Token received: eyJhbGciOiJSUzI...
DEBUG: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG: Looking up user with firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2026-01-02 10:00:17,438 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 7e399408-010e-4910-9d3e-ade06c9e619e
[get_script_and_verify_access] Querying database for script...
DEBUG: User lookup result: Found
âœ… Completed: GET /api/ai/chat/script/7e399408-010e-4910-9d3e-ade06c9e619e/conversations - 200 - 0.162s
INFO:     127.0.0.1:56614 - "GET /api/ai/chat/script/7e399408-010e-4910-9d3e-ade06c9e619e/conversations HTTP/1.1" 200 OK
ðŸ”µ Incoming request: OPTIONS /api/ai/chat/conversations/6bd76efd-ff62-43da-9089-b144f33f7259
âœ… Completed: OPTIONS /api/ai/chat/conversations/6bd76efd-ff62-43da-9089-b144f33f7259 - 200 - 0.000s
INFO:     127.0.0.1:56614 - "OPTIONS /api/ai/chat/conversations/6bd76efd-ff62-43da-9089-b144f33f7259 HTTP/1.1" 200 OK
ðŸ”µ Incoming request: GET /api/ai/chat/conversations/6bd76efd-ff62-43da-9089-b144f33f7259
DEBUG: Authentication process started
DEBUG: Token received: eyJhbGciOiJSUzI...
DEBUG: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG: Looking up user with firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk road
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2026-01-02 10:00:17,557 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:17,557 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 7e399408-010e-4910-9d3e-ade06c9e619e. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2026-01-02 10:00:17,557 - app.routers.script_websocket - INFO - WebSocket connection established for script 7e399408-010e-4910-9d3e-ade06c9e619e
DEBUG: User lookup result: Found
DEBUG: User lookup result: Found
2026-01-02 10:00:17,797 - app.services.script_yjs_persistence - INFO - Applied 3316 persisted update(s) for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:17,797 - app.routers.script_websocket - INFO - Loaded 3316 persisted update(s) for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:17,797 - app.routers.script_websocket - INFO - After loading 3316 updates, Yjs content length: 0
2026-01-02 10:00:17,797 - app.routers.script_websocket - INFO - Yjs document empty for script 7e399408-010e-4910-9d3e-ade06c9e619e, rebuilding from scenes
2026-01-02 10:00:17,800 - app.routers.script_router - INFO - [GET /content] Script 7e399408-010e-4910-9d3e-ade06c9e619e: content_blocks=3317 blocks
2026-01-02 10:00:17,825 - app.routers.script_router - INFO - [GET /content] Script 7e399408-010e-4910-9d3e-ade06c9e619e: has_yjs_updates=True
âœ… Completed: GET /api/scripts/7e399408-010e-4910-9d3e-ade06c9e619e/content - 200 - 0.446s
INFO:     127.0.0.1:56612 - "GET /api/scripts/7e399408-010e-4910-9d3e-ade06c9e619e/content HTTP/1.1" 200 OK
âœ… Completed: GET /api/ai/chat/conversations/6bd76efd-ff62-43da-9089-b144f33f7259 - 200 - 0.318s
INFO:     127.0.0.1:56614 - "GET /api/ai/chat/conversations/6bd76efd-ff62-43da-9089-b144f33f7259 HTTP/1.1" 200 OK
2026-01-02 10:00:19,230 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2026-01-02 10:00:19,230 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2026-01-02 10:00:19,231 - app.services.redis_pubsub - INFO - Subscribed to script 7e399408-010e-4910-9d3e-ade06c9e619e channels
2026-01-02 10:00:19,231 - app.routers.script_websocket - INFO - Subscribed to Redis for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:19,231 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:19,238 - app.routers.script_websocket - INFO - Replied with SyncStep2 (260313 bytes)
2026-01-02 10:00:19,238 - app.routers.script_websocket - INFO - Sent SyncStep1 to client (138 bytes state vector)
2026-01-02 10:00:19,238 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2026-01-02 10:00:19,389 - app.routers.script_websocket - INFO - Broadcasted SYNC_STEP2 as SYNC_UPDATE to peers
2026-01-02 10:00:50,369 - app.routers.script_websocket - INFO - Client disconnected from script 7e399408-010e-4910-9d3e-ade06c9e619e: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2026-01-02 10:00:50,370 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: Unexpected ASGI message 'websocket.send', after sending 'websocket.close' or response already completed.
2026-01-02 10:00:50,370 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 7e399408-010e-4910-9d3e-ade06c9e619e
INFO:     connection closed
2026-01-02 10:00:50,370 - app.services.redis_pubsub - INFO - Unsubscribed from script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:50,371 - app.routers.script_websocket - INFO - WebSocket connection closed for script 7e399408-010e-4910-9d3e-ade06c9e619e

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 7e399408-010e-4910-9d3e-ade06c9e619e <<<
2026-01-02 10:00:50,474 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 7e399408-010e-4910-9d3e-ade06c9e619e <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56672 - "WebSocket /api/ws/scripts/7e399408-010e-4910-9d3e-ade06c9e619e?token=eyJhbGciOiJSUzI1NiIsImtpZCI6ImEzOGVhNmEwNDA4YjBjYzVkYTE4OWRmYzg4ODgyZDBmMWI3ZmJmMGUiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NzAzMTA5NSwidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY3Mzc0OTI0LCJleHAiOjE3NjczNzg1MjQsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.enJayneMZtPZAIwSQGR-H_VMlAwHq5m2yDalD5EdP-G9I3oSx2CgNseQwX-edQoLJVQASJg1BvUhy7rOkgsCFipmZ0ZPAW0csq4BJlF8O8mJYRpbOBKWers3JJMF2Xnl07w7n7Dw2YJ3G1SoaSYs0kJTsFmsI-eTp18PuV1P4QuC2XiNf-GHo902UFoLXdJ15Vknf-AnRFgjipDE2GUA7vZE7Z-g4OBR4eBhQJZKQWo40tRhqL0Xz7iiALqXVT9aMTSCNjSrhn_jYKY0O7ixcaPeIgesrnx-pkCjLg91H7QL1TOYtRXB-CP-m-rzlZY0C6AAsF8VPxrio7tAqErbfw" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2026-01-02 10:00:50,474 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 3: Starting token verification for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:50,474 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2026-01-02 10:00:50,477 - app.routers.script_websocket - INFO - Token verified successfully for script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2026-01-02 10:00:50,529 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 7e399408-010e-4910-9d3e-ade06c9e619e
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 7e399408-010e-4910-9d3e-ade06c9e619e
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk road
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2026-01-02 10:00:50,632 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:50,633 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 7e399408-010e-4910-9d3e-ade06c9e619e. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2026-01-02 10:00:50,633 - app.routers.script_websocket - INFO - WebSocket connection established for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:51,194 - app.services.script_yjs_persistence - INFO - Applied 3317 persisted update(s) for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:51,194 - app.routers.script_websocket - INFO - Loaded 3317 persisted update(s) for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:51,194 - app.routers.script_websocket - INFO - After loading 3317 updates, Yjs content length: 0
2026-01-02 10:00:51,194 - app.routers.script_websocket - INFO - Yjs document empty for script 7e399408-010e-4910-9d3e-ade06c9e619e, rebuilding from scenes
2026-01-02 10:00:55,223 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2026-01-02 10:00:55,224 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2026-01-02 10:00:55,224 - app.services.redis_pubsub - INFO - Subscribed to script 7e399408-010e-4910-9d3e-ade06c9e619e channels
2026-01-02 10:00:55,224 - app.routers.script_websocket - INFO - Subscribed to Redis for script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:55,224 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 7e399408-010e-4910-9d3e-ade06c9e619e
2026-01-02 10:00:55,224 - app.routers.script_websocket - INFO - Replied with SyncStep2 (270 bytes)
2026-01-02 10:00:55,224 - app.routers.script_websocket - INFO - Sent SyncStep1 to client (138 bytes state vector)
2026-01-02 10:00:55,224 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2026-01-02 10:00:55,278 - app.routers.script_websocket - INFO - Broadcasted SYNC_STEP2 as SYNC_UPDATE to peers