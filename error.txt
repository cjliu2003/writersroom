ðŸ”µ Incoming request: GET /api/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35/content
DEBUG: Authentication process started
DEBUG: Token received: eyJhbGciOiJSUzI...
DEBUG: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG: Looking up user with firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:34:48,417 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
DEBUG: User lookup result: Found
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:34:50,062 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:34:50,062 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:34:50,062 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:34:50,191 - app.routers.script_router - INFO - [GET /content] Script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: content_blocks=3317 blocks
2025-12-13 11:34:50,586 - app.routers.script_router - INFO - [GET /content] Script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: has_yjs_updates=True
âœ… Completed: GET /api/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35/content - 200 - 3.538s
INFO:     127.0.0.1:56202 - "GET /api/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35/content HTTP/1.1" 200 OK
2025-12-13 11:34:52,625 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:34:52,625 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:34:52,625 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:34:52,625 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:35:19,102 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56252 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:35:19,103 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:19,103 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:35:19,109 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:35:20,653 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:35:26,940 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:26,940 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 2 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:35:26,940 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:39,559 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:39,560 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:39,560 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:35:39,560 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:35:50,212 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56301 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:35:50,212 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:50,212 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:35:50,214 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:35:53,666 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:35:55,779 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:35:55,779 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 3 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:35:55,779 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:00,265 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:00,265 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:00,265 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:36:00,265 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:36:23,211 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56347 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:36:23,212 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:23,212 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:36:23,214 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:36:26,561 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
2025-12-13 11:36:28,245 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:36:28,245 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:36:28,247 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:36:28,247 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,247 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,249 - app.routers.script_websocket - ERROR - Error processing binary message: 
2025-12-13 11:36:28,249 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: 
2025-12-13 11:36:28,249 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: 
2025-12-13 11:36:28,250 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,250 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,250 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:36:28,252 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:36:28,252 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: Cannot call "send" once a close message has been sent.
2025-12-13 11:36:28,252 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,253 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,253 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:36:28,374 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:28,374 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:36:28,374 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:33,554 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:33,555 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:33,555 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:36:33,555 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:36:56,213 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56439 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:36:56,213 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:36:56,213 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:36:56,217 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:36:57,724 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:37:01,591 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:01,591 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 2 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:37:01,591 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:12,205 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:12,205 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:12,205 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:37:12,206 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:37:28,096 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56643 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:37:28,097 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:28,098 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:37:28,102 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:37:31,473 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:37:38,609 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:38,610 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 3 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:37:38,610 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:44,656 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:44,656 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:44,656 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:37:44,656 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
2025-12-13 11:37:45,379 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:37:45,379 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:37:45,380 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:37:45,380 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:45,380 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:45,382 - app.routers.script_websocket - ERROR - Error processing binary message: Cannot call "send" once a close message has been sent.
2025-12-13 11:37:45,382 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: 
2025-12-13 11:37:45,382 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: 
2025-12-13 11:37:45,383 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:45,383 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:45,383 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:37:45,385 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:37:45,386 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:45,386 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:46,878 - app.routers.script_websocket - ERROR - Failed to load/initialize Yjs state for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 
Traceback (most recent call last):
  File "/Users/jacklofwall/Documents/GitHub/writersroom/backend/app/routers/script_websocket.py", line 292, in script_collaboration_websocket
    scenes_result = await db.execute(
                    ^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 452, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 199, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2191, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 587, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 261, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 246, in chunks
    post_load.invoke(context, path)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 1543, in invoke
    loader(
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/strategies.py", line 3212, in _load_for_path
    self._load_via_parent(
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/strategies.py", line 3288, in _load_via_parent
    context.session.execute(
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2306, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2191, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 293, in orm_execute_statement
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1421, in execute
    return meth(
           ^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 514, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1643, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1849, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1989, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2359, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1970, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 924, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 572, in execute
    self._adapt_connection.await_(
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 127, in await_only
    return current.driver.switch(awaitable)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 192, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 550, in _prepare_and_execute
    self._handle_exception(error)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 501, in _handle_exception
    self._adapt_connection._handle_exception(error)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 791, in _handle_exception
    raise error
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 538, in _prepare_and_execute
    self._rows = await prepared_stmt.fetch(*parameters)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 176, in fetch
    data = await self.__bind_execute(args, 0, timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 241, in __bind_execute
    data, status, _ = await self.__do_execute(
                      ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/asyncpg/prepared_stmt.py", line 230, in __do_execute
    return await executor(protocol)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "asyncpg/protocol/protocol.pyx", line 207, in bind_execute
TimeoutError
2025-12-13 11:37:46,890 - app.routers.script_websocket - ERROR - WebSocket error for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: Cannot call "send" once a close message has been sent.
2025-12-13 11:37:46,890 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:46,890 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 244, in run_asgi
    result = await self.app(self.scope, self.asgi_receive, self.asgi_send)  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/middleware/errors.py", line 151, in __call__
    await self.app(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/middleware/base.py", line 103, in __call__
    await self.app(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/middleware/cors.py", line 75, in __call__
    await self.app(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/backend/app/middleware/payload_size_limiter.py", line 26, in __call__
    await self.app(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/routing.py", line 758, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/routing.py", line 778, in app
    await route.handle(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/routing.py", line 375, in handle
    await self.app(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/routing.py", line 98, in app
    await wrap_app_handling_exceptions(app, session)(scope, receive, send)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/_exception_handler.py", line 64, in wrapped_app
    raise exc
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/starlette/routing.py", line 96, in app
    await func(session)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/fastapi/routing.py", line 345, in app
    async with AsyncExitStack() as async_exit_stack:
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 754, in __aexit__
    raise exc_details[1]
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 737, in __aexit__
    cb_suppress = await cb(*exc_details)
                  ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 217, in __aexit__
    await anext(self.gen)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/backend/app/db/base.py", line 63, in get_db
    await session.commit()
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 1000, in commit
    await greenlet_spawn(self.sync_session.commit)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 186, in greenlet_spawn
    result = context.switch(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1972, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 139, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1264, in commit
    trans.commit()
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2632, in commit
    self._do_commit()
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2737, in _do_commit
    self._connection_commit_impl()
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2708, in _connection_commit_impl
    self.connection._commit_impl()
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1149, in _commit_impl
    self._handle_dbapi_exception(e, None, None, None, None)
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2359, in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1147, in _commit_impl
    self.engine.dialect.do_commit(self.connection)
                                  ^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 588, in connection
    return self._revalidate_connection()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 680, in _revalidate_connection
    self._invalid_transaction()
  File "/Users/jacklofwall/Documents/GitHub/writersroom/writersRoom/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 670, in _invalid_transaction
    raise exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: Can't reconnect until invalid transaction is rolled back.  Please rollback() fully before proceeding (Background on this error at: https://sqlalche.me/e/20/8s2b)
2025-12-13 11:37:50,551 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:37:50,551 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:37:50,552 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:37:50,552 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:50,552 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:50,554 - app.routers.script_websocket - ERROR - Error processing binary message: Cannot call "send" once a close message has been sent.
2025-12-13 11:37:50,555 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:37:50,557 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:37:50,558 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:37:50,559 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:38:22,099 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:56934 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:38:22,100 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:22,100 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:38:22,105 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:38:23,629 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:38:27,823 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:27,823 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 2 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:38:27,823 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:32,041 - app.services.script_yjs_persistence - INFO - Applied 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:32,042 - app.routers.script_websocket - INFO - Loaded 11 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:32,042 - app.routers.script_websocket - INFO - After loading 11 updates, Yjs content length: 0
2025-12-13 11:38:32,042 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
2025-12-13 11:38:38,151 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:38:38,151 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:38:38,152 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:38:38,152 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:38,152 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:38,153 - app.routers.script_websocket - ERROR - Error processing binary message: Cannot call "send" once a close message has been sent.
2025-12-13 11:38:38,154 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: 
2025-12-13 11:38:38,154 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:38,154 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:38:38,156 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:38:38,157 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:38,157 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:39,935 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:38:39,935 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:38:39,936 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:38:39,936 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:39,936 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:39,938 - app.routers.script_websocket - ERROR - Error processing binary message: Cannot call "send" once a close message has been sent.
2025-12-13 11:38:39,938 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:38:39,941 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:38:39,942 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:38:39,942 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:39:02,801 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:39:02,802 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:39:02,802 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:39:02,802 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:39:02,802 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:39:02,817 - app.routers.script_websocket - INFO - Replied with SyncStep2 (251868 bytes)
2025-12-13 11:39:02,818 - app.routers.script_websocket - INFO - Sent SyncStep1 to client (9 bytes state vector)
2025-12-13 11:39:02,818 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:39:03,618 - app.routers.script_websocket - INFO - Broadcasted SYNC_STEP2 as SYNC_UPDATE to peers
INFO:     connection closed
2025-12-13 11:40:24,145 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:40:24,146 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: Unexpected ASGI message 'websocket.send', after sending 'websocket.close' or response already completed.
2025-12-13 11:40:24,146 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:24,151 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:24,152 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:40:25,092 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:57757 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:40:25,092 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:25,092 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:40:25,097 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:40:27,869 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:40:29,199 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:29,199 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:40:29,199 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:32,084 - app.services.script_yjs_persistence - INFO - Applied 12 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:32,084 - app.routers.script_websocket - INFO - Loaded 12 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:32,084 - app.routers.script_websocket - INFO - After loading 12 updates, Yjs content length: 0
2025-12-13 11:40:32,084 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
2025-12-13 11:40:48,591 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:40:48,591 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:40:48,592 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:40:48,592 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:48,593 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:40:48,594 - app.routers.script_websocket - INFO - Replied with SyncStep2 (2 bytes)
2025-12-13 11:40:48,594 - app.routers.script_websocket - INFO - Sent SyncStep1 to client (9 bytes state vector)
2025-12-13 11:40:48,595 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:40:49,308 - app.routers.script_websocket - INFO - Broadcasted SYNC_STEP2 as SYNC_UPDATE to peers
INFO:     connection closed
2025-12-13 11:41:24,109 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:41:24,110 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: Unexpected ASGI message 'websocket.send', after sending 'websocket.close' or response already completed.
2025-12-13 11:41:24,110 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:24,111 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:24,111 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:41:25,084 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:58141 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:41:25,085 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:25,085 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:41:25,090 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:41:26,232 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:41:28,439 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:28,439 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:41:28,439 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:34,221 - app.services.script_yjs_persistence - INFO - Applied 13 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:34,221 - app.routers.script_websocket - INFO - Loaded 13 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:41:34,221 - app.routers.script_websocket - INFO - After loading 13 updates, Yjs content length: 0
2025-12-13 11:41:34,221 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
2025-12-13 11:42:06,707 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:42:06,708 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:42:06,708 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:42:06,709 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:42:06,709 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:42:06,710 - app.routers.script_websocket - INFO - Replied with SyncStep2 (2 bytes)
2025-12-13 11:42:06,710 - app.routers.script_websocket - INFO - Sent SyncStep1 to client (9 bytes state vector)
2025-12-13 11:42:06,711 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:42:07,323 - app.routers.script_websocket - INFO - Broadcasted SYNC_STEP2 as SYNC_UPDATE to peers
INFO:     connection closed
2025-12-13 11:43:20,864 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:43:20,866 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: Unexpected ASGI message 'websocket.send', after sending 'websocket.close' or response already completed.
2025-12-13 11:43:20,866 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:20,870 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:20,871 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:43:20,965 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:58801 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:43:20,965 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:20,965 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:43:20,968 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:43:22,203 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:43:23,551 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:23,552 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 1 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:43:23,552 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:25,793 - app.services.script_yjs_persistence - INFO - Applied 14 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:25,793 - app.routers.script_websocket - INFO - Loaded 14 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:25,793 - app.routers.script_websocket - INFO - After loading 14 updates, Yjs content length: 0
2025-12-13 11:43:25,793 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
INFO:     connection closed

>>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
2025-12-13 11:43:53,195 - app.routers.script_websocket - INFO - >>> SCRIPT WEBSOCKET ENDPOINT CALLED for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 <<<
[SCRIPT WS] Step 1: Accepting WebSocket connection...
INFO:     127.0.0.1:58985 - "WebSocket /api/ws/scripts/82245154-8c4a-4c4a-8159-8d6f8c5c4a35?token=eyJhbGciOiJSUzI1NiIsImtpZCI6Ijk1MTg5MTkxMTA3NjA1NDM0NGUxNWUyNTY0MjViYjQyNWVlYjNhNWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiSmFjayBMb2Z3YWxsIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FDZzhvY0paVWpvN0E5QzcxNnNTdW1yUldHMmV0ck92RmNqRWlaMUg0eTRhUG9PR3o1MkwtQ3M9czk2LWMiLCJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vd3JpdGVyc3Jvb20tYzc4YzkiLCJhdWQiOiJ3cml0ZXJzcm9vbS1jNzhjOSIsImF1dGhfdGltZSI6MTc2NTU3ODYzNywidXNlcl9pZCI6InJMaExtT2dKRVVZOFVlQUFuZHM4STdNaTFYNzIiLCJzdWIiOiJyTGhMbU9nSkVVWThVZUFBbmRzOEk3TWkxWDcyIiwiaWF0IjoxNzY1NjIyMDYxLCJleHAiOjE3NjU2MjU2NjEsImVtYWlsIjoiamxvZndhbGxAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZ29vZ2xlLmNvbSI6WyIxMTIwMjU4NjA1OTcwMTY2MDA1MDQiXSwiZW1haWwiOlsiamxvZndhbGxAZ21haWwuY29tIl19LCJzaWduX2luX3Byb3ZpZGVyIjoiZ29vZ2xlLmNvbSJ9fQ.TMO2U7Kucb-RknJGHwiR2EpmkFYFDOw2U0Dt-fxvPdLFt6jfVInYVZncCffKCHvpEYm4zSYwBaqtOGcOinka5v4dAMeF0MdVe3aS3FtbBWX1-d4l-aesKaIQtHxFnipLkx1nUKhrp1tZjURK23JTJiRtitvcTACW3B9ZQmjzWC4DUaXxuryiwmZAJ3bAi8t_j_61t_xpa2kOPG5-hh39j8FkwHdx33-P02u3Dqwl7jtmzL20RcfOp0-yojN99oF_OaubC4Om0T-e5gn7DTLedd3K6voD3BIpDa9miK4kb2hcuCqWN0Kg8AXrW2nHSl9KaDLnM5BLZ5H9bO7GR9b4mQ" [accepted]
[SCRIPT WS] Step 2: WebSocket accepted successfully
2025-12-13 11:43:53,196 - app.routers.script_websocket - INFO - WebSocket connection accepted for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 3: Starting token verification for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:53,196 - app.routers.script_websocket - INFO - Verifying token for WebSocket connection to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 4: Calling verify_token_websocket()...
DEBUG WS: Token received: eyJhbGciOiJSUzI...
DEBUG WS: Token verified successfully, uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Token keys: ['name', 'picture', 'iss', 'aud', 'auth_time', 'user_id', 'sub', 'iat', 'exp', 'email', 'email_verified', 'firebase', 'uid']
DEBUG WS: Extracted firebase_uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
DEBUG WS: Returning decoded token with uid: rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 5: Token verification succeeded!
2025-12-13 11:43:53,198 - app.routers.script_websocket - INFO - Token verified successfully for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 6: Extracting firebase_uid from user_info...
[SCRIPT WS] Step 7: firebase_uid = rLhLmOgJEUY8UeAAnds8I7Mi1X72
[SCRIPT WS] Step 8: Looking up user in database...
INFO:     connection open
[SCRIPT WS] Step 9: Database lookup complete, user found = True
[SCRIPT WS] Step 10: User identified - Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852)
2025-12-13 11:43:54,489 - app.routers.script_websocket - INFO - WebSocket connection attempt by user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[SCRIPT WS] Step 11: Verifying script access...
[get_script_and_verify_access] Checking access for user 2157d1b1-b88f-4b4f-a25b-13dc50dea852 to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
[get_script_and_verify_access] Querying database for script...
[get_script_and_verify_access] Script found: True
[get_script_and_verify_access] Script owner: 2157d1b1-b88f-4b4f-a25b-13dc50dea852, User: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
[get_script_and_verify_access] User is the owner
[get_script_and_verify_access] Access verified successfully
[SCRIPT WS] Step 12: Script access verified! Script title: silk_road_090825
[SCRIPT WS] Step 13: Registering with WebSocket manager (connection already accepted)...
2025-12-13 11:43:56,090 - app.routers.script_websocket - INFO - Registering WebSocket for user Jack Lofwall to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:56,090 - app.routers.script_websocket - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) connected to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35. Room now has 2 participant(s)
[SCRIPT WS] Step 14: WebSocket registered successfully
2025-12-13 11:43:56,090 - app.routers.script_websocket - INFO - WebSocket connection established for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:56,579 - app.routers.script_websocket - INFO - Rebuilt 3317 blocks from 148 scenes
2025-12-13 11:43:56,579 - app.routers.script_websocket - INFO - Backend seeding disabled - frontend will seed from REST API (3317 blocks available)
2025-12-13 11:43:56,579 - app.services.redis_pubsub - INFO - Subscribed to script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35 channels
2025-12-13 11:43:56,579 - app.routers.script_websocket - INFO - Subscribed to Redis for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:56,579 - app.routers.script_websocket - INFO - Entering message loop for user Jack Lofwall on script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:56,580 - app.routers.script_websocket - ERROR - Error processing binary message: 
2025-12-13 11:43:56,580 - app.services.redis_pubsub - INFO - Started listening to Redis pub/sub messages
2025-12-13 11:43:56,584 - app.routers.script_websocket - INFO - Client disconnected from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35: 2157d1b1-b88f-4b4f-a25b-13dc50dea852
2025-12-13 11:43:56,584 - app.services.websocket_manager - ERROR - Error broadcasting to user 2157d1b1-b88f-4b4f-a25b-13dc50dea852: Cannot call "send" once a close message has been sent.
2025-12-13 11:43:56,585 - app.services.websocket_manager - INFO - User Jack Lofwall (2157d1b1-b88f-4b4f-a25b-13dc50dea852) disconnected from scene 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:56,585 - app.services.redis_pubsub - INFO - Unsubscribed from script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:56,585 - app.routers.script_websocket - INFO - WebSocket connection closed for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:58,263 - app.services.script_yjs_persistence - INFO - Applied 14 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:58,263 - app.routers.script_websocket - INFO - Loaded 14 persisted update(s) for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35
2025-12-13 11:43:58,263 - app.routers.script_websocket - INFO - After loading 14 updates, Yjs content length: 0
2025-12-13 11:43:58,264 - app.routers.script_websocket - INFO - Yjs document empty for script 82245154-8c4a-4c4a-8159-8d6f8c5c4a35, rebuilding from scenes
