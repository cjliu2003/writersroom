/**
 * Screenplay Formatting Styles
 *
 * Industry-standard screenplay formatting for TipTap editor.
 * Measurements use millimeters (mm) to match pagination extension units.
 *
 * Positioning is relative to the page left margin (1.5" = 38.1mm),
 * which is already set by the pagination extension.
 */

/* Global Screenplay Editor Styles */
.screenplay-editor {
  font-family: var(--font-courier-prime), 'Courier Prime', 'Courier New', monospace;
  font-size: 12pt;
  line-height: 12pt;  /* Match Final Draft's 6 lines per inch (12pt baseline-to-baseline) */
  letter-spacing: -0.02em;  /* Tighten characters to match Final Draft's rendering */
  color: #000;
  background: #fff;
}

/* Remove default margins from all screenplay elements */
.screenplay-editor p {
  margin: 0;
}

/* Scene Heading (Slug Line) */
.screenplay-editor .screenplay-scene-heading,
.screenplay-editor [data-type="scene-heading"] {
  margin-left: 0 !important; /* Flush with left margin */
  max-width: none !important;
  text-transform: uppercase;
  /* Note: Scene headings are NOT bold in standard screenplay format */
  margin-top: 24pt !important; /* Double-space before */
  margin-bottom: 12pt !important; /* Single-space after */
}

/* First element on each page should not have top margin.
 * [data-rm-pagination] is inserted by PaginationPlus at position 0 with side: -1,
 * AFTER .rm-first-page-header (side: -2). So this rule targets:
 * - Page 1: The first content element (scene heading, action, etc.)
 * - Pages 2+: The first content element after each page break
 * Without this, scene headings would add 24pt (32px) margin pushing content down.
 */
.screenplay-editor [data-rm-pagination] + * {
  margin-top: 0 !important;
}

/* Action (Scene Description) */
.screenplay-editor .screenplay-action,
.screenplay-editor [data-type="action"] {
  margin-left: 0 !important; /* Flush with left margin */
  max-width: none !important;
  margin-top: 12pt !important; /* Single-space before (matches Character for seamless Tab switching) */
  margin-bottom: 12pt !important; /* Single-space after */
  /* line-height inherited from .screenplay-editor */
}

/* Character Name (Character Cue) */
.screenplay-editor .screenplay-character,
.screenplay-editor [data-type="character"] {
  /* Standard: 3.7" from page left edge = 2.2" from 1.5" left margin */
  /* 2.2" = 55.88mm additional indent */
  /* !important needed to override Tailwind prose styles */
  width: fit-content !important;
  max-width: none !important;
  margin-left: 50.5mm !important; /* ~3.5" from page left edge */
  margin-right: auto !important;
  text-transform: uppercase;
  margin-top: 12pt !important; /* Single-space before */
  margin-bottom: 0 !important; /* No space after (dialogue follows immediately) */
}

/* Character CONT'D decoration
 * Displayed automatically when the same character speaks after an action line.
 * This is computed at render time via ProseMirror decorations, not stored in the document.
 */
.screenplay-editor .character-contd {
  color: inherit; /* Match the character name color */
  font-style: normal;
  text-transform: uppercase;
  user-select: none; /* Not selectable */
  pointer-events: none; /* Not interactive */
}

/* Dialogue */
.screenplay-editor .screenplay-dialogue,
.screenplay-editor [data-type="dialogue"] {
  /* Standard: 2.5" from page left edge = 1.0" from 1.5" left margin */
  /* Width adjusted from 88.9mm (3.5") to 86mm to compensate for letter-spacing: -0.02em */
  /* This ensures exactly 35 characters per line, matching Final Draft */
  /* !important needed to override Tailwind prose styles */
  width: 88.332mm !important; /* ~335px for 35 chars with letter-spacing */
  max-width: 88.332mm !important;
  margin-left: 25.4mm !important; /* 2.5" from page left edge */
  margin-right: 64.068mm !important; /* adjusted for 88.332mm width */
  margin-bottom: 12pt !important; /* Single-space after */
}

/* Dialogue followed by more dialogue (multi-paragraph speech) should have no bottom margin */
.screenplay-editor .screenplay-dialogue:has(+ .screenplay-dialogue),
.screenplay-editor .screenplay-dialogue:has(+ [data-type="dialogue"]),
.screenplay-editor [data-type="dialogue"]:has(+ .screenplay-dialogue),
.screenplay-editor [data-type="dialogue"]:has(+ [data-type="dialogue"]) {
  margin-bottom: 0 !important;
}

/* Dialogue followed by parenthetical should have no bottom margin */
.screenplay-editor .screenplay-dialogue:has(+ .screenplay-parenthetical),
.screenplay-editor .screenplay-dialogue:has(+ [data-type="parenthetical"]),
.screenplay-editor [data-type="dialogue"]:has(+ .screenplay-parenthetical),
.screenplay-editor [data-type="dialogue"]:has(+ [data-type="parenthetical"]) {
  margin-bottom: 0 !important;
}

/* Parenthetical */
.screenplay-editor .screenplay-parenthetical,
.screenplay-editor [data-type="parenthetical"] {
  /* 26 characters per line including parentheses */
  /* 26 chars รท 10 chars/inch = 2.6 inches = 66.04mm width */
  /* !important needed to override Tailwind prose styles */
  width: 62.5mm !important; /* ~236px for 26 chars with letter-spacing */
  max-width: 62.5mm !important;
  margin-left: 35.75mm !important; /* ~2.9" from page left edge */
  margin-right: 92.33mm !important; /* adjusted for 62.5mm width */
  font-style: normal; /* NOT italic - standard screenplay format */
  margin-top: 0 !important; /* No space before (follows character/dialogue immediately) */
  margin-bottom: 0 !important; /* No space after (dialogue follows immediately) */
}

/* Parentheses are now real text characters in the document, not CSS pseudo-elements.
   This allows users to edit/delete parentheses like normal text. */

/* Transition */
.screenplay-editor .screenplay-transition,
.screenplay-editor [data-type="transition"] {
  text-align: right !important;
  text-transform: uppercase;
  max-width: none !important;
  margin-top: 12pt !important; /* Single-space before */
  margin-bottom: 12pt !important; /* Single-space after */
  position: relative;
  padding-right: 0.6em; /* Space for the colon */
}

/* Auto-add colon to transitions - absolutely positioned to stay after text */
.screenplay-editor .screenplay-transition::after,
.screenplay-editor [data-type="transition"]::after {
  content: ':';
  position: absolute;
  right: 0;
  top: 0; /* Pin to first line even when empty */
}

/* Collaboration Cursor Styling (preserve from POC) */
.collaboration-cursor__caret {
  position: relative;
  margin-left: -1px;
  margin-right: -1px;
  border-left: 1px solid;
  border-right: 1px solid;
  word-break: normal;
  pointer-events: none;
}

.collaboration-cursor__label {
  position: absolute;
  top: -1.4em;
  left: -1px;
  font-size: 12px;
  font-style: normal;
  font-weight: 600;
  line-height: normal;
  user-select: none;
  color: #fff;
  padding: 0.1rem 0.3rem;
  border-radius: 3px 3px 3px 0;
  white-space: nowrap;
}

/* Ensure ProseMirror focus styles don't interfere */
.screenplay-editor .ProseMirror:focus {
  outline: none;
}

/* Placeholder styling for empty elements */
.screenplay-editor .ProseMirror p.is-editor-empty:first-child::before {
  color: #adb5bd;
  content: attr(data-placeholder);
  float: left;
  height: 0;
  pointer-events: none;
}

/* Page break styling (from pagination extension) */
.screenplay-editor .page-break {
  border-top: 2px dashed #ccc;
  margin: 2rem 0;
  padding-top: 2rem;
  page-break-after: always;
}

/* Find/Replace Match Highlighting */
.screenplay-editor .find-match {
  background-color: #fef08a; /* Yellow-200 */
  border-radius: 2px;
}

.screenplay-editor .find-current-match {
  background-color: #fb923c; /* Orange-400 */
  border-radius: 2px;
  box-shadow: 0 0 0 1px rgba(251, 146, 60, 0.5);
}

/* ============================================
   Text Formatting Marks (Bold, Italic, Underline)

   Using synthetic styles to maintain monospace character width.
   This prevents pagination/line-break shifts when formatting text.

   Shortcuts:
   - Bold: Cmd+B / Ctrl+B
   - Italic: Cmd+I / Ctrl+I
   - Underline: Cmd+U / Ctrl+U
   ============================================ */

/* Bold - uses Courier Prime Bold (700) font variant
   Courier Prime Bold has identical character widths to Regular */
.screenplay-editor strong,
.screenplay-editor b {
  font-weight: 700;  /* Use loaded Courier Prime Bold */
  font-synthesis: none;  /* Prevent browser from synthesizing */
}

/* Italic - uses Courier Prime Italic font variant
   Courier Prime Italic has identical character widths to Regular */
.screenplay-editor em,
.screenplay-editor i {
  font-style: italic;  /* Use loaded Courier Prime Italic */
  font-synthesis: none;  /* Prevent browser from synthesizing */
}

/* Underline - already width-stable, just style it nicely */
.screenplay-editor u {
  text-decoration: underline;
  text-decoration-thickness: 1px;
  text-underline-offset: 2px;
}

/* SmartType ghost text - inline autocomplete preview */
.smart-type-ghost {
  color: #9ca3af;
  pointer-events: none;
  user-select: none;
  font-style: normal;
  font-weight: normal;
  text-decoration: none;
}

/* ==========================================================================
   Dual Dialogue Layout - CSS Grid
   ========================================================================== */

/*
 * Dual dialogue displays two character+dialogue pairs side-by-side.
 * Uses CSS Grid for layout with wrapper nodes:
 * - dualDialogueBlock: Grid container with two equal columns
 * - dualDialogueColumn: Flex container for vertical stacking
 *
 * Structure:
 * <div class="dual-dialogue-block">
 *   <div class="dual-dialogue-column dual-dialogue-column--left">
 *     <p class="screenplay-character">CHARACTER 1</p>
 *     <p class="screenplay-dialogue">Dialogue...</p>
 *   </div>
 *   <div class="dual-dialogue-column dual-dialogue-column--right">
 *     <p class="screenplay-character">CHARACTER 2</p>
 *     <p class="screenplay-dialogue">Dialogue...</p>
 *   </div>
 * </div>
 */

/* --- Dual Dialogue Block (Grid Container) --- */

.screenplay-editor .dual-dialogue-block {
  display: grid;
  grid-template-columns: 1fr 1fr;  /* Two equal columns */
  gap: 6mm;                        /* ~24px gap between columns */
  margin-top: 12pt !important;     /* Single-space before (like other blocks) */
  margin-bottom: 12pt !important;  /* Single-space after */
  margin-left: 0 !important;       /* Align with page margins */
  margin-right: 0 !important;
  align-items: start;              /* Both columns start from same top position */
}

/* --- Dual Dialogue Column (Flex Container) --- */

.screenplay-editor .dual-dialogue-column {
  display: flex;
  flex-direction: column;
  align-items: stretch;            /* Children span full column width by default */
  gap: 0;                          /* No gap - elements control their own spacing */
}

/* --- Character inside Dual Dialogue Column --- */

.screenplay-editor .dual-dialogue-column .screenplay-character {
  /* Override page-relative margins - use column-relative positioning */
  margin-left: auto !important;
  margin-right: auto !important;
  margin-top: 0 !important;        /* No top margin - block handles spacing */
  margin-bottom: 0 !important;     /* No bottom margin - dialogue follows immediately */
  width: auto !important;
  max-width: 100% !important;
  text-align: center;              /* Center character name in column */
}

/* --- Dialogue inside Dual Dialogue Column --- */

.screenplay-editor .dual-dialogue-column .screenplay-dialogue {
  /* Override page-relative margins - span full column width */
  margin-left: 0 !important;
  margin-right: 0 !important;
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  width: 100% !important;
  max-width: 100% !important;
}

/* Multiple dialogue blocks in same column: add small spacing between them */
.screenplay-editor .dual-dialogue-column .screenplay-dialogue + .screenplay-dialogue {
  margin-top: 12pt !important;     /* Single-space between dialogue paragraphs */
}

/* --- Parenthetical inside Dual Dialogue Column --- */

.screenplay-editor .dual-dialogue-column .screenplay-parenthetical {
  /* Narrower and centered within column */
  /* Keep mm-based width for consistency with standard parenthetical */
  margin-left: auto !important;
  margin-right: auto !important;
  margin-top: 0 !important;
  margin-bottom: 0 !important;
  width: 80% !important;           /* Narrower than dialogue */
  max-width: 50mm !important;      /* Cap width for very wide columns */
  text-align: left;                /* Text left-aligned within the element */
}

/* --- Legacy class cleanup --- */
/* These --dual modifier classes are deprecated but kept for backwards compatibility
   during migration. They no longer affect layout - the wrapper structure handles it. */

.screenplay-editor .screenplay-character--dual,
.screenplay-editor .screenplay-dialogue--dual,
.screenplay-editor .screenplay-parenthetical--dual {
  /* No special styling needed - wrapper structure handles positioning */
}
